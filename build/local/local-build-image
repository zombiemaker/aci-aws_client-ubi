#!/bin/bash
source ./env.sh

# IMAGE_BUILD_ID should not be the hash of the latest git commit of the image source code
# because the source code may not have changed.  Image builds may be triggered for
# the following reasons:
#
# - Image source code changes
# - Image base image changes
# - OS software changes
# - Application execution environment software changes
# - Application software source code changes
# - Application software binary code changes
if [ ! -f ${IMAGE_BUILD_COUNTER_FILE} ]; then
    echo 0 > ${IMAGE_BUILD_COUNTER_FILE};
    IMAGE_BUILD_COUNTER=0;
else
    IMAGE_BUILD_COUNTER=$(cat $IMAGE_BUILD_COUNTER_FILE)
    IMAGE_BUILD_COUNTER=$((IMAGE_BUILD_COUNTER+1))
    echo ${IMAGE_BUILD_COUNTER} > ${IMAGE_BUILD_COUNTER_FILE}
    echo "IMAGE_BUILD_COUNTER = $IMAGE_BUILD_COUNTER"
fi

export IMAGE_BUILD_ID=${IMAGE_BUILD_COUNTER}
export IMAGE_TAG=${IMAGE_TAG_BASE}-${IMAGE_BUILD_ID};
export IMAGE_TAG_LATEST=${IMAGE_TAG_BASE}-latest;

# Make sure thot no variable value has space characters in it
echo "IMAGE_SOURCECODE_GIT_REPO_URL=${IMAGE_SOURCECODE_GIT_REPO_URL}" > ${IMAGE_INFOFILE_NAME}
echo "IMAGE_SOURCECODE_GIT_BRANCH=${IMAGE_SOURCECODE_GIT_BRANCH}" >> ${IMAGE_INFOFILE_NAME}
echo "IMAGE_SOURCECODE_GIT_COMMIT_HASH=${IMAGE_SOURCECODE_GIT_COMMIT_HASH}" >> ${IMAGE_INFOFILE_NAME}
echo "IMAGE_SOURCECODE_GIT_COMMIT_TAG=${IMAGE_SOURCECODE_GIT_TAG}" >> ${IMAGE_INFOFILE_NAME}
echo "IMAGE_SOURCECODE_GIT_COMMITTER_NAME=\"${IMAGE_SOURCECODE_GIT_COMMITTER_NAME}\"" >> ${IMAGE_INFOFILE_NAME}
echo "IMAGE_SOURCECODE_GIT_COMMITTER_DATE=\"${IMAGE_SOURCECODE_GIT_COMMITTER_DATE}\"" >> ${IMAGE_INFOFILE_NAME}
echo "IMAGE_CLASS=$IMAGE_CLASS" >> ${IMAGE_INFOFILE_NAME}
echo "IMAGE_OS_BRAND=$IMAGE_OS_BRAND" >> ${IMAGE_INFOFILE_NAME}
echo "IMAGE_OS_VERSION=$IMAGE_OS_VERSION" >> ${IMAGE_INFOFILE_NAME}
echo "APP_PLATFORM_BRAND=$APP_PLATFORM_BRAND" >> ${IMAGE_INFOFILE_NAME}
echo "APP_PLATFORM_VERSION=$APP_PLATFORM_VERSION" >> ${IMAGE_INFOFILE_NAME}
echo "APP_BRAND=$APP_BRAND" >> ${IMAGE_INFOFILE_NAME}
echo "APP_VERSION=$APP_VERSION" >> ${IMAGE_INFOFILE_NAME}
echo "APP_SOURCECODE_GIT_REPO_URL=$APP_SOURCECODE_GIT_REPO_URL" >> ${IMAGE_INFOFILE_NAME}
echo "APP_SOURCECODE_GIT_BRANCH=$APP_SOURCECODE_GIT_BRANCH" >> ${IMAGE_INFOFILE_NAME}
echo "APP_SOURCECODE_GIT_COMMIT_HASH=$APP_SOURCECODE_GIT_COMMIT_HASH" >> ${IMAGE_INFOFILE_NAME}
echo "APP_SOURCECODE_GIT_COMMIT_TAG=$APP_SOURCECODE_GIT_TAG" >> ${IMAGE_INFOFILE_NAME}
echo "APP_SOURCECODE_GIT_COMMITTER_NAME=\"$APP_SOURCECODE_GIT_COMMITTER_NAME\"" >> ${IMAGE_INFOFILE_NAME}
echo "APP_SOURCECODE_GIT_COMMITTER_DATE=\"$APP_SOURCECODE_GIT_COMMITTER_DATE\"" >> ${IMAGE_INFOFILE_NAME}
echo "IMAGE_REPO_HOSTNAME=$IMAGE_REPO_HOSTNAME" >> ${IMAGE_INFOFILE_NAME}
echo "IMAGE_REPO_OWNERNAME=$IMAGE_REPO_OWNERNAME" >> ${IMAGE_INFOFILE_NAME}
echo "IMAGE_REPO_NAME=$IMAGE_REPO_NAME" >> ${IMAGE_INFOFILE_NAME}
echo "IMAGE_BUILD_COUNTER=$IMAGE_BUILD_COUNTER" >> ${IMAGE_INFOFILE_NAME}
echo "IMAGE_BUILD_ID=$IMAGE_BUILD_ID" >> ${IMAGE_INFOFILE_NAME}
# echo "IMAGE=$IMAGE" >> ${IMAGE_INFOFILE_NAME}
echo "IMAGE_TAG_BASE=$IMAGE_TAG_BASE" >> ${IMAGE_INFOFILE_NAME}
echo "IMAGE_TAG=$IMAGE_TAG" >> ${IMAGE_INFOFILE_NAME}
echo "IMAGE_TAG_LATEST=$IMAGE_TAG_LATEST" >> ${IMAGE_INFOFILE_NAME}

cp ./${IMAGE_INFOFILE_NAME} ${DOCKERFILE_RELATIVE_PATH}/${IMAGE_INFOFILE_NAME}

docker build \
    -f ${DOCKERFILE_RELATIVE_PATH}/${DOCKERFILE_NAME} \
    --tag ${IMAGE_REPO_NAME}:${IMAGE_TAG} \
    --build-arg IMAGE_SOURCECODE_GIT_REPO_URL=$IMAGE_SOURCECODE_GIT_REPO_URL \
    --build-arg IMAGE_SOURCECODE_GIT_BRANCH=$IMAGE_SOURCECODE_GIT_BRANCH \
    --build-arg IMAGE_SOURCECODE_GIT_COMMIT_HASH=$IMAGE_SOURCECODE_GIT_COMMIT_HASH \
    --build-arg IMAGE_SOURCECODE_GIT_COMMIT_TAG=$IMAGE_SOURCECODE_GIT_TAG \
    --build-arg IMAGE_SOURCECODE_GIT_COMMITTER_NAME="$IMAGE_SOURCECODE_GIT_COMMITTER_NAME" \
    --build-arg IMAGE_SOURCECODE_GIT_COMMITTER_DATE="$IMAGE_SOURCECODE_GIT_COMMITTER_DATE" \
    --build-arg IMAGE_CLASS=$IMAGE_CLASS \
    --build-arg IMAGE_OS_BRAND=$IMAGE_OS_BRAND \
    --build-arg IMAGE_OS_VERSION=$IMAGE_OS_VERSION \
    --build-arg APP_PLATFORM_BRAND=$APP_PLATFORM_BRAND \
    --build-arg APP_PLATFORM_VERSION=$APP_PLATFORM_VERSION \
    --build-arg APP_BRAND=$APP_BRAND \
    --build-arg APP_VERSION=$APP_VERSION \
    --build-arg APP_SOURCECODE_GIT_REPO_URL=$APP_SOURCECODE_GIT_REPO_URL \
    --build-arg APP_SOURCECODE_GIT_BRANCH=$APP_SOURCECODE_GIT_BRANCH \
    --build-arg APP_SOURCECODE_GIT_COMMIT_HASH=$APP_SOURCECODE_GIT_COMMIT_HASH \
    --build-arg APP_SOURCECODE_GIT_COMMIT_TAG=$APP_SOURCECODE_GIT_TAG \
    --build-arg APP_SOURCECODE_GIT_COMMITTER_NAME="$APP_SOURCECODE_GIT_COMMITTER_NAME" \
    --build-arg APP_SOURCECODE_GIT_COMMITTER_DATE="$APP_SOURCECODE_GIT_COMMITTER_DATE" \
    ${DOCKERFILE_RELATIVE_PATH}